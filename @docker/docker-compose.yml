version: '3.8'

services:
  backend:
    build:
      context: ..
      dockerfile: "@docker/Dockerfile.backend"
    container_name: ludolist-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-1338}:1337"
    environment:
      - NODE_ENV=production
      - HOST=0.0.0.0
      - PORT=1337
      - DATABASE_CLIENT=${DATABASE_CLIENT:-sqlite}
      - DATABASE_HOST=${DATABASE_HOST:-}
      - DATABASE_PORT=${DATABASE_PORT:-}
      - DATABASE_NAME=${DATABASE_NAME:-strapi}
      - DATABASE_USERNAME=${DATABASE_USERNAME:-}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD:-}
      # DATABASE_FILENAME: chemin dans le conteneur (le volume @data/ludolist/db est montÃ© dans /data/db)
      - DATABASE_FILENAME=${DATABASE_FILENAME:-/data/db/data.db}
      - APP_KEYS=${APP_KEYS}
      - API_TOKEN_SALT=${API_TOKEN_SALT:-}
      - ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET:-}
      - TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT:-}
      - JWT_SECRET=${JWT_SECRET:-}
    volumes:
      - ../@data/ludolist/db:/data/db:rw
      - ../@data/ludolist/uploads:/app/public/uploads:rw
    networks:
      - ludolist-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:1337/api', (r) => {process.exit(r.statusCode === 200 || r.statusCode === 404 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: ..
      dockerfile: "@docker/Dockerfile.frontend"
    container_name: ludolist-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3001}:3000"
    environment:
      - NODE_ENV=production
      - NUXT_HOST=0.0.0.0
      - NUXT_PORT=3000
      - NUXT_PUBLIC_API_URL=${NUXT_PUBLIC_API_URL:-http://backend:1337}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - ludolist-network
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  ludolist-network:
    driver: bridge
